<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>IBE Companion Assessment</title>
<style>
  :root{
    --bg:#070707;
    --panel:rgba(255,255,255,.03);
    --edge:rgba(255,255,255,.12);
    --text:#d8d8d8;
    --muted:#a6a6a6;
    --accent:#b87333;
  }
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;}
  .wrap{max-width:1020px;margin:auto;padding:14px}
  .bar{
    display:flex;gap:10px;flex-wrap:wrap;align-items:center;
    border:1px solid var(--edge);background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    border-radius:18px;padding:12px;box-shadow:0 18px 45px rgba(0,0,0,.30)
  }
  .left{margin-right:auto;color:var(--muted);font-size:12.5px}
  .pill{
    font-size:12px;color:var(--muted);
    border:1px solid rgba(255,255,255,.14);
    border-radius:999px;padding:6px 10px;background:rgba(255,255,255,.03);
  }
  button{
    appearance:none;border-radius:14px;border:1px solid rgba(255,255,255,.18);
    background:rgba(255,255,255,.05);color:var(--text);padding:10px 12px;
    cursor:pointer;font-size:14px
  }
  button.primary{border-color:rgba(184,115,51,.62);background:rgba(184,115,51,.14)}
  button.primary:disabled{opacity:.45;cursor:not-allowed}
  button.ghost{background:rgba(255,255,255,.03)}
  button.danger{border-color:rgba(122,15,22,.55);background:rgba(122,15,22,.18)}
  .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
  .card{
    border:1px solid var(--edge);background:linear-gradient(180deg, rgba(255,255,255,.035), rgba(255,255,255,.02));
    border-radius:18px;padding:14px;box-shadow:0 18px 45px rgba(0,0,0,.25)
  }
  .k{display:flex;gap:10px;align-items:baseline;flex-wrap:wrap}
  .qnum{color:var(--muted);font-size:12px}
  .axis{color:rgba(184,115,51,.9);font-size:12px;border:1px solid rgba(184,115,51,.35);border-radius:999px;padding:3px 8px}
  .prompt{font-size:16px;line-height:1.25;margin:8px 0 10px}
  .opts{display:grid;grid-template-columns:1fr;gap:8px}
  .opt{
    border:1px solid rgba(255,255,255,.14);
    border-radius:14px;
    background:rgba(0,0,0,.25);
    padding:10px 12px;
    cursor:pointer;
    user-select:none;
    transition:transform .04s ease, border-color .15s ease, background .15s ease;
    font-size:14px;line-height:1.25
  }
  .opt:hover{transform:translateY(-1px);border-color:rgba(184,115,51,.35)}
  .opt.selected{border-color:rgba(184,115,51,.8);background:rgba(184,115,51,.10)}
  .opt small{display:block;color:var(--muted);margin-top:6px}
  .modalBack{
    position:fixed;inset:0;display:none;align-items:center;justify-content:center;
    background:rgba(0,0,0,.72);padding:14px;z-index:99
  }
  .modal{
    width:min(720px, 100%);
    border:1px solid rgba(255,255,255,.15);
    border-radius:18px;
    background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    box-shadow:0 22px 70px rgba(0,0,0,.55);
    padding:14px
  }
  .modalHead{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .modalTitle{font-size:14px;color:var(--muted);margin-right:auto}
  pre, textarea{
    width:100%;
    background:rgba(0,0,0,.30);
    border:1px solid rgba(255,255,255,.12);
    border-radius:18px;
    color:var(--text);
    padding:12px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size:12.5px;
    line-height:1.35;
  }
  textarea{min-height:120px;resize:vertical}
  pre{white-space:pre-wrap;margin:12px 0 0}
  .hidden{display:none}
  @media (max-width:520px){
    .prompt{font-size:15px}
    .bar{gap:8px}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="bar">
    <div class="left" id="progress">0/12 answered</div>
    <div class="pill" id="statusPill">In progress</div>

    <button class="ghost" id="resetBtn" type="button">Reset</button>
    <button class="primary" id="finishBtn" type="button" disabled>Finish</button>

    <select id="exportFmt" class="hidden">
      <option value="txt">Export Summary .txt</option>
      <option value="doc">Export Summary .doc</option>
      <option value="pdf">Export Summary PDF</option>
    </select>
    <button id="exportBtn" class="hidden" type="button">Export</button>

    <button class="danger" id="wipeBtn" type="button">Wipe Device Save</button>
  </div>

  <div id="app" class="grid"></div>
</div>

<div class="modalBack" id="summaryBack" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modalHead">
      <div class="modalTitle">Summary</div>
      <button class="ghost" id="copyCodeBtn" type="button">Copy Result Code</button>
      <button class="ghost" id="closeSummary" type="button">Close</button>
    </div>

    <pre id="summaryText"></pre>

    <div style="height:10px"></div>
    <div class="pill" style="display:inline-flex;gap:8px;align-items:center;">
      Result Code
    </div>
    <div style="height:10px"></div>
    <textarea id="resultCode" readonly></textarea>
  </div>
</div>

<script>
/* ============================================================
FSM TAKER (single pass)
- Captures integrity telemetry:
  - per-question answer time
  - total active time
  - option position selected
  - answer changes
  - very fast counts thresholds
- Generates:
  - plain English Summary (only)
  - Result Code payload for mentor decoder
============================================================ */

const BUILD = "IBE_COMPANION_TAKER_v1.0";
const STORAGE_KEY = "FSM_TAKER_V4_STATE";

// ---- Question bank (12) ----
const QUESTIONS = [
  {
    key:"q1",
    axis:"Isolation Reflex",
    prompt:"When isolation hits hard (unplanned and total), you usually:",
    options:[
      "Contain it and get razor-focused\u2014solitude sharpens me.",
      "Channel it into motion\u2014work, tasks, movement, anything.",
      "Reach out\u2014tell someone the truth instead of drowning alone.",
      "Dissect it\u2014loop the memory/meaning until it makes sense."
    ]
  },
  {
    key:"q2",
    axis:"Emotional Regulation",
    prompt:"When emotion starts getting too loud, your first move is:",
    options:[
      "Clamp down and stay functional\u2014no leaks.",
      "Redirect the energy\u2014lift, build, clean, fix.",
      "Name it out loud\u2014even if it costs pride.",
      "Translate it into logic\u2014what is this feeling trying to say?"
    ]
  },
  {
    key:"q3",
    axis:"Identity Under Pressure",
    prompt:"When pressure threatens your identity, you tend to:",
    options:[
      "Double down\u2014hold the line and keep control.",
      "Shift into performance\u2014do what works and keep it moving.",
      "Tell the truth about what you need, even if it\u2019s uncomfortable.",
      "Step back and reframe\u2014who am I becoming through this?"
    ]
  },
  {
    key:"q4",
    axis:"Trust Breakdown Pattern",
    prompt:"When someone breaks your trust, your reflex is to:",
    options:[
      "Close the door\u2014access revoked.",
      "Move on and stay busy\u2014no time to bleed.",
      "Confront it directly\u2014clear it or cut it clean.",
      "Try to understand the pattern\u2014why did it happen, and what does it reveal?"
    ]
  },
  {
    key:"q5",
    axis:"Breaking Point Edge",
    prompt:"When you feel close to breaking a promise to yourself, you usually:",
    options:[
      "Get hard on yourself\u2014discipline through consequence.",
      "Outwork the urge\u2014replace the impulse with action.",
      "Pull in accountability\u2014say it before it owns you.",
      "Interrogate the trigger\u2014what need is underneath this?"
    ]
  },
  {
    key:"q6",
    axis:"Boundary Enforcement",
    prompt:"When someone crosses a line, you tend to:",
    options:[
      "Enforce immediately\u2014no debate.",
      "Create distance through action\u2014remove yourself, change access, move forward.",
      "State the boundary clearly\u2014explain once, then hold it.",
      "Analyze what you allowed\u2014what loophole did they walk through?"
    ]
  },
  {
    key:"q7",
    axis:"Strength Code",
    prompt:"Being \u2018strong\u2019 mostly means you:",
    options:[
      "Maintain control and composure no matter what.",
      "Show up and execute\u2014do the work even when it hurts.",
      "Protect and provide\u2014people feel safer because you\u2019re there.",
      "Live in clarity\u2014see what\u2019s true and act from it."
    ]
  },
  {
    key:"q8",
    axis:"Attachment Reflex",
    prompt:"When someone gets emotionally close, you usually:",
    options:[
      "Keep it controlled\u2014let them in slowly, on your terms.",
      "Keep moving\u2014closeness is fine, but don\u2019t slow my mission.",
      "Lean in\u2014connection is fuel, not danger.",
      "Study them\u2014and yourself\u2014before you trust the bond."
    ]
  },
  {
    key:"q9",
    axis:"Justice vs Release",
    prompt:"When you\u2019re deeply hurt, you tend to:",
    options:[
      "Cut them off\u2014no access, no explanation.",
      "Convert it into forward motion\u2014build, win, outgrow it.",
      "Talk it out if possible\u2014close it clean, say the real thing.",
      "Let it go internally\u2014release the poison without reopening the door."
    ]
  },
  {
    key:"q10",
    axis:"Purpose Orientation",
    prompt:"When life feels meaningless, you usually:",
    options:[
      "Impose structure\u2014routines, standards, non-negotiables.",
      "Move\u2014purpose follows momentum.",
      "Serve someone\u2014helping restores meaning.",
      "Sit with it\u2014meaning emerges when you listen long enough."
    ]
  },
];

// Hidden A/B/C/D mapping (mentor uses; taker never sees labels)
QUESTIONS.forEach(q=>{
  q.map = {
    [q.options[0]]:"A",
    [q.options[1]]:"B",
    [q.options[2]]:"C",
    [q.options[3]]:"D"
  };
});

const CODE_LABEL = {
  A:"Containment / Control",
  B:"Action / Channeling",
  C:"Connection / Exposure",
  D:"Analysis / Meaning-Making"
};
const SHADOW_OF = {A:"A",B:"B",C:"A",D:"D"};

// ---- RNG / Shuffle ----
function mulberry32(a){
  return function(){
    let t=a+=0x6D2B79F5;
    t=Math.imul(t^(t>>>15),t|1);
    t^=t+Math.imul(t^(t>>>7),t|61);
    return ((t^(t>>>14))>>>0)/4294967296;
  }
}
function shuffle(arr,rng){
  const a=arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(rng()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function hashKey(k){
  let h=2166136261;
  for(let i=0;i<k.length;i++){
    h ^= k.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return (h>>>0);
}

// ---- Base64url helpers ----
function b64urlEncode(obj){
  const json = JSON.stringify(obj);
  const b64 = btoa(unescape(encodeURIComponent(json)));
  return b64.replaceAll("+","-").replaceAll("/","_").replaceAll("=","");
}
function b64urlDecode(code){
  const b64 = code.trim().replaceAll("-","+").replaceAll("_","/");
  const pad = (b64.length % 4) ? "=".repeat(4 - (b64.length % 4)) : "";
  const raw = atob(b64 + pad);
  const json = decodeURIComponent(escape(raw));
  return JSON.parse(json);
}

// ---- State ----
let seed = null;
let rng = null;
let ORDER = [];
let answers = {};            // key -> option text
let firstSeenAt = {};        // key -> first render ts
let lastAnswerAt = {};       // key -> last answer ts
let timeSpentMs = {};        // key -> accumulated ms
let chosenPos = {};          // key -> position 1-4 chosen
let answerChanges = 0;
let selectionLog = [];
let startedAt = Date.now();
let finishedAt = null;

// ---- DOM ----
const app = document.getElementById("app");
const progressEl = document.getElementById("progress");
const statusPill = document.getElementById("statusPill");
const resetBtn = document.getElementById("resetBtn");
const wipeBtn = document.getElementById("wipeBtn");
const finishBtn = document.getElementById("finishBtn");
const summaryBack = document.getElementById("summaryBack");
const summaryTextEl = document.getElementById("summaryText");
const resultCodeEl = document.getElementById("resultCode");
const copyCodeBtn = document.getElementById("copyCodeBtn");
const closeSummary = document.getElementById("closeSummary");

// ---- Persistence ----
function saveState(){
  const state = {
    seed, answers, firstSeenAt, lastAnswerAt, timeSpentMs, chosenPos,
    answerChanges, selectionLog, startedAt, finishedAt
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return false;
    const s = JSON.parse(raw);
    seed = s.seed ?? null;
    answers = s.answers || {};
    firstSeenAt = s.firstSeenAt || {};
    lastAnswerAt = s.lastAnswerAt || {};
    timeSpentMs = s.timeSpentMs || {};
    chosenPos = s.chosenPos || {};
    answerChanges = Number(s.answerChanges || 0);
    selectionLog = s.selectionLog || [];
    startedAt = Number(s.startedAt || Date.now());
    finishedAt = s.finishedAt ?? null;
    return true;
  }catch(e){
    return false;
  }
}
function wipeSave(){
  localStorage.removeItem(STORAGE_KEY);
}

// ---- Initialize order ----
function initOrder(){
  if(seed == null){
    seed = Date.now() ^ (Math.random()*1e9|0);
  }
  rng = mulberry32(seed);
  // shuffle questions deterministically
  ORDER = shuffle(QUESTIONS, rng);
}
function ensureFirstSeen(){
  const now = Date.now();
  ORDER.forEach(q=>{
    if(firstSeenAt[q.key] == null) firstSeenAt[q.key] = now;
  });
}

// ---- Render ----
function answeredCount(){
  return ORDER.filter(q=>answers[q.key]).length;
}
function allAnswered(){
  return answeredCount() === ORDER.length;
}
function render(){
  ensureFirstSeen();

  const done = answeredCount();
  progressEl.textContent = `${done}/${ORDER.length} answered`;
  statusPill.textContent = allAnswered() ? "Ready" : "In progress";
  finishBtn.disabled = !allAnswered();

  app.innerHTML = "";
  ORDER.forEach((q, idx)=>{
    const card = document.createElement("div");
    card.className = "card";

    const head = document.createElement("div");
    head.className = "k";
    head.innerHTML = `
      <div class="qnum">Q${idx+1}</div>
     `;
    card.appendChild(head);

    const prompt = document.createElement("div");
    prompt.className = "prompt";
    prompt.textContent = q.prompt;
    card.appendChild(prompt);

    const opts = document.createElement("div");
    opts.className = "opts";

    q.options.forEach((optText, optIdx)=>{
      const opt = document.createElement("div");
      opt.className = "opt" + ((answers[q.key] === optText) ? " selected" : "");
      opt.textContent = optText;
      opt.addEventListener("click", ()=>selectOption(q, optText, optIdx+1));
      opts.appendChild(opt);
    });

    card.appendChild(opts);
    app.appendChild(card);
  });
}

// ---- Selection logic + timing ----
function selectOption(q, optText, pos){
  const now = Date.now();

  // accumulate time since last answer interaction for this question
  const last = lastAnswerAt[q.key] ?? firstSeenAt[q.key] ?? now;
  const delta = Math.max(0, now - last);
  timeSpentMs[q.key] = (timeSpentMs[q.key] || 0) + delta;

  // count changes (changing to a different option)
  if(answers[q.key] && answers[q.key] !== optText){
    answerChanges++;
  }

  answers[q.key] = optText;
  chosenPos[q.key] = pos;
  lastAnswerAt[q.key] = now;

  // minimal selection log (keep last 200)
  selectionLog.push({ t: now, k: q.key, p: pos, ch: answerChanges });
  if(selectionLog.length > 220) selectionLog = selectionLog.slice(-220);

  saveState();
  render();
}

// ---- Profile computation ----
function computePattern(codes){
  const counts = {A:0,B:0,C:0,D:0};
  (codes||[]).forEach(c=>{ if(counts[c]!==undefined) counts[c]++; });

  const sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]);
  const primary = sorted[0][0];
  const secondary = sorted[1][0];
  const shadow = SHADOW_OF[primary] || "C";

  const groupName = (p,s)=>{
    const pair = `${p}${s}`;
    const map = {
      "AB":"The Disciplined Engine",
      "AC":"The Protector",
      "AD":"The Architect",
      "BA":"The Hard Reset",
      "BC":"The Rally Point",
      "BD":"The Strategist",
      "CA":"The Guarded Truth",
      "CB":"The Workhorse Heart",
      "CD":"The Witness",
      "DA":"The Iron Philosopher",
      "DB":"The Quiet Builder",
      "DC":"The Truth Teller",
    };
    return map[pair] || `${CODE_LABEL[p]} / ${CODE_LABEL[s]}`;
  };

  const growth = {
    A:"Upgrade: keep your standard, but soften the grip. Control with choice, not fear.",
    B:"Upgrade: keep moving, but stop using motion to outrun what you feel.",
    C:"Upgrade: keep your honesty, but don’t make connection your only regulator—build self-trust too.",
    D:"Upgrade: keep your insight, but timebox the loop—meaning must convert into action."
  }[primary] || "Upgrade: pick one small adjustment and repeat it for a week.";


  const watch = {
    A:"Watch for: rigidity, emotional shutdown, and ‘my way or nothing’ under stress.",
    B:"Watch for: overdrive, burnout, and distraction dressed up as discipline.",
    C:"Watch for: dependence on external validation or reassurance when you’re activated.",
    D:"Watch for: analysis paralysis—understanding becoming avoidance."
  }[primary] || "Watch for: drift under fatigue.";


  return {
    counts, primary, secondary, shadow,
    group: groupName(primary,secondary),
    growth, watch
  };
}

function computeProfile(){
  // include selected codes A/B/C/D in ORDER
  const codes = ORDER.map(q=>{
    const sel = answers[q.key];
    return sel ? q.map[sel] : null;
  });
  const p = computePattern(codes);
  return { ...p, codes };
}

// ---- Summary (taker only) ----
function buildSummaryPlain(p){
  const groupLine = `You landed in: ${p.group}.`;
  const defaultLine = {
    A:"Your default is containment and control: you stabilize from the inside out.",
    B:"Your default is action and channeling: you turn intensity into motion.",
    C:"Your default is connection and exposure: you regulate through truth with others.",
    D:"Your default is analysis and meaning-making: you regulate through understanding."
  }[p.primary];


  const tradeoffLine = {
    A:"The tradeoff: control can become shutdown—strength turns into distance.",
    B:"The tradeoff: motion can become avoidance—work turns into anesthesia.",
    C:"The tradeoff: connection can become dependence—your nervous system needs more than one outlet.",
    D:"The tradeoff: insight can become a loop—clarity without motion becomes a cage."
  }[p.primary];


  const underLoadLine = {
    A:"Under heavy load, you can clamp down harder than you intend and go emotionally quiet.",
    B:"Under heavy load, you can sprint—more intensity, less presence—until you burn out.",
    C:"Under heavy load, you can retreat into self-protection and stop asking for what you need.",
    D:"Under heavy load, you can get stuck in analysis and delay the hard move."
  }[p.shadow];


  const mix = `Today’s pattern mix: A:${p.counts.A}  B:${p.counts.B}  C:${p.counts.C}  D:${p.counts.D}.`;

  return [
    "Summary",
    "",
    groupLine,
    "",
    mix,
    "",
    defaultLine,
    tradeoffLine,
    "",
    underLoadLine,
    "",
    "What helps (simple and real):",
    p.growth
  ].join("\n");
}

// ---- Telemetry packaging for mentor ----
function finalizePayload(){
  finishedAt = Date.now();

  // compute per-question times in display order (ms)
  const perQ = ORDER.map(q=>{
    const ms = timeSpentMs[q.key] || 0;
    return {
      key: q.key,
      pos: chosenPos[q.key] || null,
      ms
    };
  });

  const totalActiveMs = perQ.reduce((s,x)=>s + (x.ms||0), 0);

  // include selected codes A/B/C/D in ORDER
  const codes = ORDER.map(q=>{
    const sel = answers[q.key];
    return sel ? q.map[sel] : null;
  });

  const payload = {
    v: BUILD,
    seed,
    // display order
    orderKeys: ORDER.map(q=>q.key),
    // selected answers (raw text)
    answers,
    // computed A/B/C/D codes (mentor uses for pattern)
    codes,
    // integrity telemetry
    telem: {
      startedAt,
      finishedAt,
      totalActiveMs,
      perQ,                // key/pos/ms
      answerChanges,
      selectionEvents: selectionLog.slice(-200) // last 200 events is enough
    }
  };

  return payload;
}

// ---- Modal / export ----
function openSummary(){ summaryBack.style.display="flex"; }
function closeSummaryModal(){ summaryBack.style.display="none"; }
closeSummary.addEventListener("click", closeSummaryModal);
summaryBack.addEventListener("click", (e)=>{ if(e.target===summaryBack) closeSummaryModal(); });

function escapeHtml(str){
  return str.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
            .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function downloadBlob(filename, content, mime){
  const blob = new Blob([content], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 250);
}

// ---- Buttons ----
resetBtn.addEventListener("click", ()=>{
  if(!confirm("Reset all answers?")) return;
  answers = {};
  firstSeenAt = {};
  lastAnswerAt = {};
  timeSpentMs = {};
  chosenPos = {};
  answerChanges = 0;
  selectionLog = [];
  startedAt = Date.now();
  finishedAt = null;
  summaryTextEl.textContent = "";
  resultCodeEl.value = "";
  saveState();
  render();
});

wipeBtn.addEventListener("click", ()=>{
  if(!confirm("Wipe saved state on this device?")) return;
  wipeSave();
  answers = {};
  firstSeenAt = {};
  lastAnswerAt = {};
  timeSpentMs = {};
  chosenPos = {};
  answerChanges = 0;
  selectionLog = [];
  startedAt = Date.now();
  finishedAt = null;
  summaryTextEl.textContent = "";
  resultCodeEl.value = "";
  render();
});

finishBtn.addEventListener("click", ()=>{
  if(!allAnswered()){
    alert("Answer all questions first.");
    return;
  }
  const prof = computeProfile();
  const summary = buildSummaryPlain(prof);
  summaryTextEl.textContent = summary;

  const payload = finalizePayload();
  const code = b64urlEncode(payload);
  resultCodeEl.value = code;

  saveState();
  openSummary();
});

copyCodeBtn.addEventListener("click", async ()=>{
  const code = (resultCodeEl.value || "").trim();
  if(!code){ alert("No result code yet."); return; }
  try{
    await navigator.clipboard.writeText(code);
    alert("Copied.");
  }catch(e){
    prompt("Copy this:", code);
  }
});

// ---- Boot ----
const loaded = loadState();
initOrder();
ensureFirstSeen();
render();
</script>
</body>
</html>
